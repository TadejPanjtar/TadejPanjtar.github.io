var HANDJS=HANDJS||{};!function(){function e(){b=!0,clearTimeout(M),M=setTimeout(function(){b=!1},700)}function t(e,t){for(;e;){if(e.contains(t))return e;e=e.parentNode}return null}function n(e,n,o){for(var r=t(e,n),i=e,a=[];i&&i!==r;)h(i,"pointerenter")&&a.push(i),i=i.parentNode;for(;a.length>0;)o(a.pop())}function o(e,n,o){for(var r=t(e,n),i=e;i&&i!==r;)h(i,"pointerleave")&&o(i),i=i.parentNode}function r(e,t){["pointerdown","pointermove","pointerup","pointerover","pointerout"].forEach(function(n){window.addEventListener(e(n),function(e){!b&&g(e.target,n)&&t(e,n,!0)})}),void 0===window["on"+e("pointerenter").toLowerCase()]&&window.addEventListener(e("pointerover"),function(e){if(!b){var o=g(e.target,"pointerenter");o&&o!==window&&(o.contains(e.relatedTarget)||n(o,e.relatedTarget,function(n){t(e,"pointerenter",!1,n,e.relatedTarget)}))}}),void 0===window["on"+e("pointerleave").toLowerCase()]&&window.addEventListener(e("pointerout"),function(e){if(!b){var n=g(e.target,"pointerleave");n&&n!==window&&(n.contains(e.relatedTarget)||o(n,e.relatedTarget,function(n){t(e,"pointerleave",!1,n,e.relatedTarget)}))}})}if(!window.PointerEvent){Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=Object(this),n=t.length>>>0;if(0===n)return-1;var o=0;if(arguments.length>0&&(o=Number(arguments[1]),o!==o?o=0:0!==o&&1/0!==o&&o!==-1/0&&(o=(o>0||-1)*Math.floor(Math.abs(o)))),o>=n)return-1;for(var r=o>=0?o:Math.max(n-Math.abs(o),0);n>r;r++)if(r in t&&t[r]===e)return r;return-1}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){if(!(this&&e instanceof Function))throw new TypeError;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/,"")});var i=["pointerdown","pointerup","pointermove","pointerover","pointerout","pointercancel","pointerenter","pointerleave"],a=["PointerDown","PointerUp","PointerMove","PointerOver","PointerOut","PointerCancel","PointerEnter","PointerLeave"],s="touch",d="pen",c="mouse",l={},v=function(e){for(;e&&!e.handjs_forcePreventDefault;)e=e.parentNode;return!!e||window.handjs_forcePreventDefault},f=function(e,t,n,o,r){var i;if(document.createEvent?(i=document.createEvent("MouseEvents"),i.initMouseEvent(t,n,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,r||e.relatedTarget)):(i=document.createEventObject(),i.screenX=e.screenX,i.screenY=e.screenY,i.clientX=e.clientX,i.clientY=e.clientY,i.ctrlKey=e.ctrlKey,i.altKey=e.altKey,i.shiftKey=e.shiftKey,i.metaKey=e.metaKey,i.button=e.button,i.relatedTarget=r||e.relatedTarget),void 0===i.offsetX&&(void 0!==e.offsetX?(Object&&void 0!==Object.defineProperty&&(Object.defineProperty(i,"offsetX",{writable:!0}),Object.defineProperty(i,"offsetY",{writable:!0})),i.offsetX=e.offsetX,i.offsetY=e.offsetY):Object&&void 0!==Object.defineProperty?(Object.defineProperty(i,"offsetX",{get:function(){return this.currentTarget&&this.currentTarget.offsetLeft?e.clientX-this.currentTarget.offsetLeft:e.clientX}}),Object.defineProperty(i,"offsetY",{get:function(){return this.currentTarget&&this.currentTarget.offsetTop?e.clientY-this.currentTarget.offsetTop:e.clientY}})):void 0!==e.layerX&&(i.offsetX=e.layerX-e.currentTarget.offsetLeft,i.offsetY=e.layerY-e.currentTarget.offsetTop)),i.isPrimary=void 0!==e.isPrimary?e.isPrimary:!0,e.pressure)i.pressure=e.pressure;else{var a=0;void 0!==e.which?a=e.which:void 0!==e.button&&(a=e.button),i.pressure=0===a?0:.5}if(i.rotation=e.rotation?e.rotation:0,i.hwTimestamp=e.hwTimestamp?e.hwTimestamp:0,i.tiltX=e.tiltX?e.tiltX:0,i.tiltY=e.tiltY?e.tiltY:0,i.height=e.height?e.height:0,i.width=e.width?e.width:0,i.preventDefault=function(){void 0!==e.preventDefault&&e.preventDefault()},void 0!==i.stopPropagation){var l=i.stopPropagation;i.stopPropagation=function(){void 0!==e.stopPropagation&&e.stopPropagation(),l.call(this)}}switch(i.pointerId=e.pointerId,i.pointerType=e.pointerType,i.pointerType){case 2:i.pointerType=s;break;case 3:i.pointerType=d;break;case 4:i.pointerType=c}o?o.dispatchEvent(i):e.target?e.target.dispatchEvent(i):e.srcElement.fireEvent("on"+E(t),i)},u=function(e,t,n,o,r){e.pointerId=1,e.pointerType=c,f(e,t,n,o,r)},p=function(e,t,n,o,r,i){var a=t.identifier+2;t.pointerId=a,t.pointerType=s,t.currentTarget=n,void 0!==o.preventDefault&&(t.preventDefault=function(){o.preventDefault()}),f(t,e,r,n,i)},h=function(e,t){return e.__handjsGlobalRegisteredEvents&&e.__handjsGlobalRegisteredEvents[t]},g=function(e,t){for(;e&&!h(e,t);)e=e.parentNode;return e?e:h(window,t)?window:void 0},m=function(e,t,n,o,r,i){g(n,e)&&p(e,t,n,o,r,i)},E=function(e){return e.toLowerCase().replace("pointer","mouse")},w=function(e,t){var n=i.indexOf(t),o=e+a[n];return o},T=function(e,t,n,o){if(void 0===e.__handjsRegisteredEvents&&(e.__handjsRegisteredEvents=[]),o){if(void 0!==e.__handjsRegisteredEvents[t])return e.__handjsRegisteredEvents[t]++,void 0;e.__handjsRegisteredEvents[t]=1,e.addEventListener(t,n,!1)}else{if(-1!==e.__handjsRegisteredEvents.indexOf(t)&&(e.__handjsRegisteredEvents[t]--,0!==e.__handjsRegisteredEvents[t]))return;e.removeEventListener(t,n),e.__handjsRegisteredEvents[t]=0}},y=function(e,t,n){if(e.__handjsGlobalRegisteredEvents||(e.__handjsGlobalRegisteredEvents=[]),n){if(void 0!==e.__handjsGlobalRegisteredEvents[t])return e.__handjsGlobalRegisteredEvents[t]++,void 0;e.__handjsGlobalRegisteredEvents[t]=1}else void 0!==e.__handjsGlobalRegisteredEvents[t]&&(e.__handjsGlobalRegisteredEvents[t]--,e.__handjsGlobalRegisteredEvents[t]<0&&(e.__handjsGlobalRegisteredEvents[t]=0));var o,r;switch(window.MSPointerEvent?(o=function(e){return w("MS",e)},r=f):(o=E,r=u),t){case"pointerenter":case"pointerleave":var i=o(t);void 0!==e["on"+i.toLowerCase()]&&T(e,i,function(e){r(e,t)},n)}},L=function(e){var t=e.prototype?e.prototype.addEventListener:e.addEventListener,n=function(e,n,o){-1!==i.indexOf(e)&&y(this,e,!0),void 0===t?this.attachEvent("on"+E(e),n):t.call(this,e,n,o)};e.prototype?e.prototype.addEventListener=n:e.addEventListener=n},_=function(e){var t=e.prototype?e.prototype.removeEventListener:e.removeEventListener,n=function(e,n,o){-1!==i.indexOf(e)&&y(this,e,!1),void 0===t?this.detachEvent(E(e),n):t.call(this,e,n,o)};e.prototype?e.prototype.removeEventListener=n:e.removeEventListener=n};L(window),L(window.HTMLElement||window.Element),L(document),navigator.isCocoonJS||(L(HTMLBodyElement),L(HTMLDivElement),L(HTMLImageElement),L(HTMLUListElement),L(HTMLAnchorElement),L(HTMLLIElement),L(HTMLTableElement),window.HTMLSpanElement&&L(HTMLSpanElement)),window.HTMLCanvasElement&&L(HTMLCanvasElement),!navigator.isCocoonJS&&window.SVGElement&&L(SVGElement),_(window),_(window.HTMLElement||window.Element),_(document),navigator.isCocoonJS||(_(HTMLBodyElement),_(HTMLDivElement),_(HTMLImageElement),_(HTMLUListElement),_(HTMLAnchorElement),_(HTMLLIElement),_(HTMLTableElement),window.HTMLSpanElement&&_(HTMLSpanElement)),window.HTMLCanvasElement&&_(HTMLCanvasElement),!navigator.isCocoonJS&&window.SVGElement&&_(SVGElement);var b=!1,M=-1;!function(){window.MSPointerEvent?r(function(e){return w("MS",e)},f):(r(E,u),void 0!==window.ontouchstart&&(window.addEventListener("touchstart",function(t){for(var o=0;o<t.changedTouches.length;++o){var r=t.changedTouches[o];l[r.identifier]=r.target,m("pointerover",r,r.target,t,!0),n(r.target,null,function(e){p("pointerenter",r,e,t,!1)}),m("pointerdown",r,r.target,t,!0)}e()}),window.addEventListener("touchend",function(t){for(var n=0;n<t.changedTouches.length;++n){var r=t.changedTouches[n],i=l[r.identifier];m("pointerup",r,i,t,!0),m("pointerout",r,i,t,!0),o(i,null,function(e){p("pointerleave",r,e,t,!1)})}e()}),window.addEventListener("touchmove",function(t){for(var r=0;r<t.changedTouches.length;++r){var i=t.changedTouches[r],a=document.elementFromPoint(i.clientX,i.clientY),s=l[i.identifier];if(s&&v(s)===!0&&t.preventDefault(),m("pointermove",i,s,t,!0),!navigator.isCocoonJS){var a=document.elementFromPoint(i.clientX,i.clientY);if(s===a)continue;s&&(m("pointerout",i,s,t,!0,a),s.contains(a)||o(s,a,function(e){p("pointerleave",i,e,t,!1,a)})),a&&(m("pointerover",i,a,t,!0,s),a.contains(s)||n(a,s,function(e){p("pointerenter",i,e,t,!1,s)})),l[i.identifier]=a}}e()}),window.addEventListener("touchcancel",function(e){for(var t=0;t<e.changedTouches.length;++t){var n=e.changedTouches[t];m("pointercancel",n,l[n.identifier],e,!0)}})))}(),void 0===navigator.pointerEnabled&&(navigator.pointerEnabled=!0,navigator.msPointerEnabled&&(navigator.maxTouchPoints=navigator.msMaxTouchPoints))}}(),function(){window.PointerEvent||document.styleSheets&&document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){if(void 0===document.body.style.touchAction){var e=new RegExp(".+?{.*?}","m"),t=new RegExp(".+?{","m"),n=function(n){var o=e.exec(n);if(o){var r=o[0];n=n.replace(r,"").trim();var i=t.exec(r)[0].replace("{","").trim();if(-1!==r.replace(/\s/g,"").indexOf("touch-action:none"))for(var a=document.querySelectorAll(i),s=0;s<a.length;s++){var d=a[s];void 0!==d.style.msTouchAction?d.style.msTouchAction="none":d.handjs_forcePreventDefault=!0}return n}},o=function(e){if(window.setImmediate)e&&setImmediate(o,n(e));else for(;e;)e=n(e)};try{for(var r=0;r<document.styleSheets.length;r++){var i=document.styleSheets[r];if(null!=i.href){var a=new XMLHttpRequest;a.open("get",i.href),a.send();var s=a.responseText.replace(/(\n|\r)/g,"");o(s)}}}catch(d){}for(var c=document.getElementsByTagName("style"),r=0;r<c.length;r++){var l=c[r],v=l.innerHTML.replace(/(\n|\r)/g,"").trim();o(v)}}},!1)}();

var Collection=function(){this.count=0,this.collection={},this.add=function(key,item){if(null==this.collection[key])return this.collection[key]=item,++this.count},this.remove=function(key){if(null!=this.collection[key])return delete this.collection[key],--this.count},this.item=function(key){return this.collection[key]},this.forEach=function(block){for(key in this.collection)this.collection.hasOwnProperty(key)&&block(this.collection[key])}},Vector2=function(x,y){this.x=x||0,this.y=y||0};Vector2.prototype={reset:function(x,y){return this.x=x,this.y=y,this},toString:function(decPlaces){decPlaces=decPlaces||3;var scalar=Math.pow(10,decPlaces);return"["+Math.round(this.x*scalar)/scalar+", "+Math.round(this.y*scalar)/scalar+"]"},clone:function(){return new Vector2(this.x,this.y)},copyTo:function(v){v.x=this.x,v.y=this.y},copyFrom:function(v){this.x=v.x,this.y=v.y},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},magnitudeSquared:function(){return this.x*this.x+this.y*this.y},normalise:function(){var m=this.magnitude();return this.x=this.x/m,this.y=this.y/m,this},reverse:function(){return this.x=-this.x,this.y=-this.y,this},plusEq:function(v){return this.x+=v.x,this.y+=v.y,this},plusNew:function(v){return new Vector2(this.x+v.x,this.y+v.y)},minusEq:function(v){return this.x-=v.x,this.y-=v.y,this},minusNew:function(v){return new Vector2(this.x-v.x,this.y-v.y)},multiplyEq:function(scalar){return this.x*=scalar,this.y*=scalar,this},multiplyNew:function(scalar){return this.clone().multiplyEq(scalar)},divideEq:function(scalar){return this.x/=scalar,this.y/=scalar,this},divideNew:function(scalar){return this.clone().divideEq(scalar)},dot:function(v){return this.x*v.x+this.y*v.y},angle:function(useRadians){return Math.atan2(this.y,this.x)*(useRadians?1:Vector2Const.TO_DEGREES)},rotate:function(angle,useRadians){var cosRY=Math.cos(angle*(useRadians?1:Vector2Const.TO_RADIANS)),sinRY=Math.sin(angle*(useRadians?1:Vector2Const.TO_RADIANS));return Vector2Const.temp.copyFrom(this),this.x=Vector2Const.temp.x*cosRY-Vector2Const.temp.y*sinRY,this.y=Vector2Const.temp.x*sinRY+Vector2Const.temp.y*cosRY,this},equals:function(v){return this.x==v.x&&this.y==v.x},isCloseTo:function(v,tolerance){return!!this.equals(v)||(Vector2Const.temp.copyFrom(this),Vector2Const.temp.minusEq(v),Vector2Const.temp.magnitudeSquared()<tolerance*tolerance)},rotateAroundPoint:function(point,angle,useRadians){Vector2Const.temp.copyFrom(this),Vector2Const.temp.minusEq(point),Vector2Const.temp.rotate(angle,useRadians),Vector2Const.temp.plusEq(point),this.copyFrom(Vector2Const.temp)},isMagLessThan:function(distance){return this.magnitudeSquared()<distance*distance},isMagGreaterThan:function(distance){return this.magnitudeSquared()>distance*distance}},Vector2Const={TO_DEGREES:180/Math.PI,TO_RADIANS:Math.PI/180,temp:new Vector2},window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};var canvas,c,container,halfWidth,halfHeight,touches,btnSize,signSize,btnJoyStr,inFullScreen=!1,leftPointerID=-1,leftPointerPos=new Vector2(0,0),leftPointerStartPos=new Vector2(0,0),leftVector=new Vector2(0,0),btnUpPressed=!1,btnDownPressed=!1,joyX=0,joyY=0,btnJoyStrPrev="";function controlsChanged(){var btnUp,btnDown;if(btnUp=btnUpPressed?1:0,btnDown=btnDownPressed?1:0,(btnJoyStr="c?x="+parseInt(500+joyX)+"&y="+parseInt(500-joyY)+"&b="+btnUp+btnDown+"000000")!=btnJoyStrPrev){console.log(btnJoyStr);var xhr=new XMLHttpRequest;xhr.open("GET",btnJoyStr),xhr.send(),btnJoyStrPrev=btnJoyStr}}function init(){setupCanvas(),touches=new Collection,canvas.addEventListener("pointerdown",onPointerDown,!1),canvas.addEventListener("pointermove",onPointerMove,!1),canvas.addEventListener("pointerup",onPointerUp,!1),canvas.addEventListener("pointerout",onPointerUp,!1),requestAnimFrame(draw)}function resetCanvas(e){canvas.width=window.innerWidth,canvas.height=window.innerHeight,halfWidth=canvas.width/2,halfHeight=canvas.height/2;var m=Math.min(canvas.width,canvas.height);signSize=(btnSize=m/4)/3,window.scrollTo(0,0)}function draw(){c.clearRect(0,0,canvas.width,canvas.height),c.strokeStyle="pink",c.fillStyle="orange",c.lineWidth=1,c.beginPath(),btnUpPressed?c.fillRect(canvas.width-btnSize,0,btnSize,btnSize):c.rect(canvas.width-btnSize,0,btnSize,btnSize),btnDownPressed?c.fillRect(canvas.width-btnSize,btnSize,btnSize,btnSize):c.rect(canvas.width-btnSize,btnSize,btnSize,btnSize),c.stroke(),c.fillStyle="red",c.beginPath(),c.moveTo(canvas.width-btnSize/2,btnSize/2-signSize),c.lineTo(canvas.width-btnSize/2+signSize/2,btnSize/2+signSize),c.lineTo(canvas.width-btnSize/2-signSize/2,btnSize/2+signSize),c.fill(),c.stroke(),c.beginPath(),c.moveTo(canvas.width-btnSize/2,btnSize+btnSize/2+signSize),c.lineTo(canvas.width-btnSize/2+signSize/2,btnSize+btnSize/2-signSize),c.lineTo(canvas.width-btnSize/2-signSize/2,btnSize+btnSize/2-signSize),c.fill(),c.stroke(),c.beginPath(),c.setLineDash([4,2]),c.moveTo(halfWidth,0),c.lineTo(halfWidth,canvas.height),c.stroke(),c.beginPath(),c.rect(0,0,30,30),c.stroke(),c.setLineDash([]),touches.forEach(function(touch){touch.identifier==leftPointerID?(c.beginPath(),c.strokeStyle="cyan",c.lineWidth=6,c.arc(leftPointerStartPos.x,leftPointerStartPos.y,40,0,2*Math.PI,!0),c.stroke(),c.beginPath(),c.strokeStyle="cyan",c.lineWidth=2,c.arc(leftPointerStartPos.x,leftPointerStartPos.y,60,0,2*Math.PI,!0),c.stroke(),c.beginPath(),c.strokeStyle="cyan",c.arc(leftPointerPos.x,leftPointerPos.y,40,0,2*Math.PI,!0)):(c.beginPath(),c.strokeStyle="red",c.lineWidth="6",c.arc(touch.x,touch.y,40,0,2*Math.PI,!0)),c.stroke()}),requestAnimFrame(draw)}function givePointerType(event){switch(event.pointerType){case event.POINTER_TYPE_MOUSE:return"MOUSE";case event.POINTER_TYPE_PEN:return"PEN";case event.POINTER_TYPE_TOUCH:return"TOUCH"}}function onPointerDown(e){var newPointer={identifier:e.pointerId,x:e.clientX,y:e.clientY,type:givePointerType(e)};leftPointerID<0&&e.clientX<halfWidth?(leftPointerID=e.pointerId,leftPointerStartPos.reset(e.clientX,e.clientY),leftPointerPos.copyFrom(leftPointerStartPos),leftVector.reset(0,0)):(e.clientX>=canvas.width-btnSize&&e.clientX<=canvas.width&&0<=e.clientY&&e.clientY<=btnSize&&(btnUpPressed=!0),e.clientX>=canvas.width-btnSize&&e.clientX<=canvas.width&&e.clientY>=btnSize&&e.clientY<=2*btnSize&&(btnDownPressed=!0)),controlsChanged(),touches.add(e.pointerId,newPointer)}function onPointerMove(e){leftPointerID==e.pointerId?(leftPointerPos.reset(e.clientX,e.clientY),leftVector.copyFrom(leftPointerPos),leftVector.minusEq(leftPointerStartPos),joyX=leftVector.x,joyY=leftVector.y):(touches.item(e.pointerId)&&(touches.item(e.pointerId).x=e.clientX,touches.item(e.pointerId).y=e.clientY),btnUpPressed=!!(touches.item(e.pointerId)&&e.clientX>=canvas.width-btnSize&&e.clientX<=canvas.width&&0<=e.clientY&&e.clientY<=btnSize),btnDownPressed=!!(touches.item(e.pointerId)&&e.clientX>=canvas.width-btnSize&&e.clientX<=canvas.width&&e.clientY>=btnSize&&e.clientY<=2*btnSize)),controlsChanged()}function onPointerUp(e){leftPointerID==e.pointerId&&(leftPointerID=-1,leftVector.reset(0,0),joyX=joyY=0),0<=e.clientX&&e.clientX<=30&&0<=e.clientY&&e.clientY<=30&&(inFullScreen?document.exitFullscreen():canvas.requestFullscreen(),inFullScreen=!inFullScreen),e.clientX>=canvas.width-btnSize&&e.clientX<=canvas.width&&0<=e.clientY&&e.clientY<=btnSize&&(btnUpPressed=!1),e.clientX>=canvas.width-btnSize&&e.clientX<=canvas.width&&e.clientY>=btnSize&&e.clientY<=2*btnSize&&(btnDownPressed=!1),controlsChanged(),touches.remove(e.pointerId)}function setupCanvas(){canvas=document.getElementById("canvasSurfaceGame"),c=canvas.getContext("2d"),resetCanvas(),c.strokeStyle="#ffffff",c.lineWidth=2}document.addEventListener("DOMContentLoaded",init),window.onorientationchange=resetCanvas,window.onresize=resetCanvas;
